apiVersion: v1
kind: Template
labels:
  template: java-ocp-job-demo
metadata:
  name: java-ocp-job-demo
  annotations:
      description: java-ocp-job-demo
      iconClass: database
      openshift.io/display-name: java-ocp-job-demo
      tags: java
objects:
- apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: jobcontrollersa
    labels:
      component: jobcontrollersa
- apiVersion: v1
  kind: DeploymentConfig
  metadata:
    name: java-ocp-job-demo-service
  spec:
    replicas: 1
    selector:
      deploymentconfig: java-ocp-job-demo-service
    strategy:
      rollingParams:
        intervalSeconds: 1
        timeoutSeconds: 1800
        updatePeriodSeconds: 1
      type: Rolling
    triggers: {}
    template:
      metadata:
        labels:
          deploymentconfig: java-ocp-job-demo-service
      spec:
        containers:
        - envFrom: 
          - configMapRef:
              name: java-job-demo-map
          image: carljmosca/java-ocp-job-demo:1.0-SNAPSHOT
          imagePullPolicy: Always
          name: java-ocp-job-demo-service
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 500m
              memory: 512Mi
        restartPolicy: Always
  status: {}
- apiVersion: v1
  kind: Service
  metadata:
    name: java-ocp-job-demo-service
  spec:
    ports:
    - name: http
      port: 8080
      targetPort: 0
    selector:
      deploymentconfig: java-ocp-job-demo-service
    sessionAffinity: None
    type: ClusterIP
- apiVersion: v1
  kind: Route
  metadata:
    name: java-ocp-job-demo
  spec:
    port:
      targetPort: "http"
    to:
      kind: Service
      name: java-ocp-job-demo-service
    tls:
      termination: edge
    wildcardPolicy: None
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: java-job-demo-map
  data:
    MASTER_URL: ${MASTER_URL}  
    JAVA_OPTIONS: ${JAVA_OPTIONS}
    MAXIMUM_JOB_TIME_IN_SECONDS: ${MAXIMUM_JOB_TIME_IN_SECONDS}
    MAXIMUM_JOBS: ${MAXIMUM_JOBS}
    PAUSE_SECONDS: ${PAUSE_SECONDS}
    TOTAL_JOBS: ${TOTAL_JOBS}        
parameters:
- description: The name for the application.
  displayName: Application name
  name: APPLICATION_NAME
  required: true
  value: java-ocp-job-demo
- description: Java options
  displayName: Java options
  name: JAVA_OPTIONS
  value: "-Xmx512m"
  required: true
- description: OpenShift Master URL
  displayName: Master URL
  name: MASTER_URL
  required: true
  value: "https://172.30.0.1:443"
- description: Maximum number of jobs to run (0 for unlimited)
  displayName: Total jobs
  name: TOTAL_JOBS
  required: true
  value: "0"
- description: Time to pause in between job processing (in seconds)
  displayName: Pause
  name: PAUSE_SECONDS
  value: "20"
  required: true
- description: Maximum number of jobs to run at one time
  displayName: Maximum jobs        
  name: MAXIMUM_JOBS
  value: "3"
  required: true
- description: Maximum time for job completion (in seconds)
  displayName: Maximum job time
  name: MAXIMUM_JOB_TIME_IN_SECONDS
  value: "20"
  required: true

